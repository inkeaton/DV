<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Università & Scienziati (D3 Mercator - Omini)</title>
  <style>
    html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    .wrap { height: 100%; display: flex; flex-direction: column; }
    header { padding: 10px 14px; border-bottom: 1px solid #e6e6e6; display: flex; gap: 12px; align-items: baseline; }
    header h1 { font-size: 16px; margin: 0; }
    header .meta { font-size: 12px; color: #666; }
    #chart { flex: 1; position: relative; }
    svg { width: 100%; height: 100%; display: block; }
    .country { fill: #f4f4f4; stroke: #cfcfcf; stroke-width: 0.6; }

    .marker path { stroke: #111; stroke-opacity: 0.25; stroke-width: 1; }
    .marker:hover path { stroke-opacity: 0.9; stroke-width: 1.4; }

    .tooltip {
      position: absolute;
      pointer-events: none;
      background: rgba(15,15,15,0.92);
      color: #fff;
      padding: 8px 10px;
      border-radius: 10px;
      font-size: 12px;
      line-height: 1.2;
      opacity: 0;
      transform: translate(-50%, -110%);
      white-space: nowrap;
    }

    .legend {
      position: absolute;
      left: 10px;
      bottom: 10px;
      background: rgba(255,255,255,0.92);
      border: 1px solid #e6e6e6;
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 12px;
      min-width: 220px;
    }
    .legend .row { display: flex; align-items: center; gap: 10px; margin-top: 6px; }
    .legend .sample svg { display: block; }
    .legend .label { color: #444; }
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>Università & scienziati (omini)</h1>
    <div class="meta" id="meta"></div>
  </header>
  <div id="chart">
    <div class="tooltip" id="tooltip"></div>
    <div class="legend" id="legend" style="display:none"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
<script src="https://cdn.jsdelivr.net/npm/topojson-client@3"></script>

<script>
(async function () {
  // =========================
  // CONFIG: metti qui i path giusti
  // =========================
  // Se metti i CSV nella stessa cartella dell'HTML -> DATA_BASE = "./"
  // Se i CSV sono in ../outputs/openalex_outputs rispetto all'HTML -> DATA_BASE = "../outputs/openalex_outputs/"
  const DATA_BASE = "../outputs/openalex_outputs/";
  
  const INSTITUTIONS_CSV = DATA_BASE + "institutions_geo.csv";
  const AUTHOR_PRIMARY_CSV = DATA_BASE + "author_primary_geo.csv";

  // world map topojson
  const WORLD_TOPOJSON_URL = "https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json";

  // dimensione omino (in pixel circa)
  const SIZE_MIN = 10;  // minimo
  const SIZE_MAX = 46;  // massimo

  // icona omino (viewBox 0..24)
  const PERSON_PATH =
    "M12 12c2.21 0 4-1.79 4-4S14.21 4 12 4 8 5.79 8 8s1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z";

  function hashToHue(str) {
    let h = 2166136261;
    for (let i = 0; i < str.length; i++) {
      h ^= str.charCodeAt(i);
      h = Math.imul(h, 16777619);
    }
    return Math.abs(h) % 360;
  }
  function uniColor(institutionId) {
    const hue = hashToHue(institutionId || "");
    return `hsl(${hue} 70% 55%)`;
  }

  // =========================
  // LOAD DATA
  // =========================
  const [worldTopo, institutionsRaw, authorPrimaryRaw] = await Promise.all([
    d3.json(WORLD_TOPOJSON_URL),
    d3.csv(INSTITUTIONS_CSV, d3.autoType),
    d3.csv(AUTHOR_PRIMARY_CSV, d3.autoType),
  ]);

  // count unique authors per institution_id (primary)
  const countByInst = d3.rollup(
    authorPrimaryRaw.filter(d => d.institution_id && d.author_id),
    v => new Set(v.map(d => d.author_id)).size,
    d => d.institution_id
  );

  // join with institutions_geo
  const institutions = institutionsRaw
    .filter(d => d.institution_id && d.latitude != null && d.longitude != null)
    .map(d => ({
      institution_id: d.institution_id,
      display_name: d.display_name || d.institution_id,
      latitude: +d.latitude,
      longitude: +d.longitude,
      n_scientists: countByInst.get(d.institution_id) || 0
    }))
    .filter(d => d.n_scientists > 0);

  const nInst = institutions.length;
  const nAuthors = d3.sum(institutions, d => d.n_scientists);
  d3.select("#meta").text(`${nInst.toLocaleString("it-IT")} università · ${nAuthors.toLocaleString("it-IT")} autori (primary)`);

  // =========================
  // DRAW MAP
  // =========================
  const chart = document.getElementById("chart");
  const tooltip = d3.select("#tooltip");
  const legend = d3.select("#legend");

  const svg = d3.select(chart).append("svg");
  const rootG = svg.append("g"); // zoom container

  function render() {
    const { width, height } = chart.getBoundingClientRect();
    svg.attr("viewBox", [0, 0, width, height]);
    rootG.selectAll("*").remove();

    const projection = d3.geoMercator()
      .fitExtent([[10, 10], [width - 10, height - 10]], { type: "Sphere" });

    const path = d3.geoPath(projection);

    // countries
    const countries = topojson.feature(worldTopo, worldTopo.objects.countries);

    rootG.append("path")
      .datum({ type: "Sphere" })
      .attr("d", path)
      .attr("fill", "#ffffff");

    rootG.selectAll("path.country")
      .data(countries.features)
      .join("path")
      .attr("class", "country")
      .attr("d", path);

    // scale size by sqrt(count)
    const maxN = d3.max(institutions, d => d.n_scientists) || 1;
    const size = d3.scaleSqrt().domain([1, maxN]).range([SIZE_MIN, SIZE_MAX]);

    // draw markers
    const markers = rootG.append("g")
      .attr("class", "markers")
      .selectAll("g.marker")
      .data(institutions, d => d.institution_id)
      .join(enter => {
        const g = enter.append("g").attr("class", "marker");
        g.append("path")
          .attr("d", PERSON_PATH)
          .attr("fill", d => uniColor(d.institution_id))
          .attr("fill-opacity", 0.82);
        return g;
      });

    markers
      .attr("transform", d => {
        const [x, y] = projection([d.longitude, d.latitude]);
        // PERSON_PATH è 24x24; vogliamo altezza ~ size(n)
        const s = (size(d.n_scientists) / 24);
        // ancoriamo bottom-center al punto: trasla al punto, scala, poi sposta -12,-24
        return `translate(${x},${y}) scale(${s}) translate(-12,-24)`;
      })
      .style("cursor", "pointer")
      .on("mouseenter", function (event, d) {
        tooltip
          .style("opacity", 1)
          .html(`<div style="font-weight:600">${d.display_name}</div>
                 <div>${d.n_scientists.toLocaleString("it-IT")} autori</div>`);
      })
      .on("mousemove", function (event) {
        const rect = chart.getBoundingClientRect();
        tooltip
          .style("left", (event.clientX - rect.left) + "px")
          .style("top", (event.clientY - rect.top) + "px");
      })
      .on("mouseleave", function () {
        tooltip.style("opacity", 0);
      });

    // zoom / pan
    svg.call(
      d3.zoom()
        .scaleExtent([1, 8])
        .on("zoom", (event) => rootG.attr("transform", event.transform))
    );

    // legend
    legend.style("display", "block");
    const steps = [1, Math.ceil(maxN/10), Math.ceil(maxN/3), maxN]
      .filter((v, i, a) => a.indexOf(v) === i)
      .sort((a,b)=>a-b);

    const sampleSvg = steps.map(v => {
      const h = size(v);
      const s = (h / 24);
      const w = Math.max(30, h + 10);
      return `
        <div class="row">
          <div class="sample">
            <svg width="${w}" height="${h+6}" viewBox="0 0 ${w} ${h+6}">
              <g transform="translate(${w/2},${h+4}) scale(${s}) translate(-12,-24)">
                <path d="${PERSON_PATH}" fill="rgba(0,0,0,0.25)"></path>
              </g>
            </svg>
          </div>
          <div class="label">${v.toLocaleString("it-IT")} autori</div>
        </div>
      `;
    }).join("");

    legend.html(`
      <div style="font-weight:600; margin-bottom:6px">Legenda</div>
      <div>Dimensione omino ∝ # autori</div>
      ${sampleSvg}
      <div style="margin-top:6px; color:#666">max: ${maxN.toLocaleString("it-IT")}</div>
    `);
  }

  render();
  window.addEventListener("resize", render);

})();
</script>
</body>
</html>

